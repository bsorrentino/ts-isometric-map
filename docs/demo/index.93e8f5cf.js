class e{constructor(e,t,s){this.screenPos=e,this.mapPos=t,this.map=s,this.highlight=!1}compare(e){return e.highlight?-1:0}render(){const{context:e}=this.map;e.save(),this._renderLines(),this.highlight&&(this._drawTileRect(),this._drawMapPos()),e.restore()}_renderImage(){this.map.renderImageScaled("cretebrick970",this.screenPos,this.map.tile)}_renderLines(){const e=this.map.getTileVertex(this.screenPos),{context:t,tile:{color:s}}=this.map;t.beginPath(),t.moveTo(e.top.x,e.top.y),t.lineTo(e.left.x,e.left.y),t.lineTo(e.bottom.x,e.bottom.y),t.lineTo(e.right.x,e.right.y),t.lineTo(e.top.x,e.top.y),t.strokeStyle="black",t.stroke()}_drawMapPos(){const{context:e}=this.map,{x:t,y:s}=this.screenPos;e.fillStyle="black",e.fillText(`${this.mapPos.x},${this.mapPos.y}`,t-40,s+20)}_drawTileRect(){const{context:e,tile:{width:t,height:s}}=this.map,{topLeft:{x:i,y:n}}=this.map.getTileRect(this.screenPos);e.beginPath(),e.rect(i,n,t,s),e.stroke()}}var t,s;(s=t||(t={}))[s.NW=0]="NW",s[s.NE=1]="NE",s[s.SW=2]="SW",s[s.SE=3]="SE";class i{constructor(e){this.screenPos=e}compare(e){const t=this.screenPos.y-e.screenPos.y;return 0===t?this.screenPos.x-e.screenPos.x:t}}class n extends i{constructor(e,t){super(t.convertIsoToScreen(e)),this.mapPos=e,this.map=t,this.move=null,this.currentImage="man-se"}compare(e){const t=this.screenPos.y-e.screenPos.y;return 0===t?this.screenPos.x-e.screenPos.x:t}_moveTo(e,t,s){if(this.map.isOnMap(t)){this.currentImage=s;const i=this.map.convertIsoToScreen(t);this.map.checkCollision(i,e,1)||(this.mapPos=t,this.screenPos=i)}}render(){switch(this.move){case t.SE:this._moveTo(t.SE,{x:this.mapPos.x+1,y:this.mapPos.y},"man-se");break;case t.SW:this._moveTo(t.SW,{x:this.mapPos.x,y:this.mapPos.y+1},"man-sw");break;case t.NE:this._moveTo(t.NE,{x:this.mapPos.x,y:this.mapPos.y-1},"man-ne");break;case t.NW:this._moveTo(t.NW,{x:this.mapPos.x-1,y:this.mapPos.y},"man-nw")}this.map.renderImage(this.currentImage,this.screenPos)}}class r{constructor(e,t){this.value=e,this.isDown=!1,this.isUp=!0;const s=e=>{e.key===this.value&&(this.isUp&&this.press&&this.press(),this.isDown=!0,this.isUp=!1,e.preventDefault())},i=e=>{e.key===this.value&&(this.isDown&&this.release&&this.release(),this.isDown=!1,this.isUp=!0,e.preventDefault())};t.addEventListener("keydown",s,!1),t.addEventListener("keyup",i,!1),this.unsubscribe=()=>{t.removeEventListener("keydown",s,!1),t.removeEventListener("keyup",i,!1)}}}class o{constructor(e){const t=e=>{this.press&&this.press(e),e.preventDefault()},s=e=>{this.up&&this.up(e),e.preventDefault()},i=e=>{this.move&&this.move(e),e.preventDefault()};e.addEventListener("mousedown",t,!1),e.addEventListener("mouseup",s,!1),e.addEventListener("mousemove",i,!1),this.unsubscribe=()=>{e.removeEventListener("mousedown",t,!1),e.removeEventListener("mouseup",s,!1),e.removeEventListener("mousemove",i,!1)}}getMousePosition(e){const t=e.target;if(null==t)return null;const s=t.getBoundingClientRect();return{x:e.clientX-s.left,y:e.clientY-s.top}}}const h=(e,t=document)=>new r(e,t);class a extends i{constructor(e,t,s){super(t),this.basename=e,this.map=s}render(){this.map.renderImage(this.basename,this.screenPos)}}const c=document.getElementById("debug"),l=new class{constructor(t){this.screenPos={x:0,y:0},this.renderLayers=[[],[],[]],this.images=new Map,this.clear=()=>this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this._addTile=(t,s)=>{const i=this.convertIsoToScreen(t),n=new e(i,t,this);return this.renderLayers[s].push(n),n},this.addEntity=(e,t)=>{const s=this.convertScreenToIso(e.screenPos);return!!this.isOnMap(s)&&(this.renderLayers[t].push(e),!0)},this.convertIsoToScreen=e=>({x:(e.x-e.y)*this.tile.width/2+this.mapPos.x,y:(e.x+e.y)*this.tile.height/2+this.mapPos.y}),this.getTileVertex=e=>({top:{x:e.x-this.tile.width/2,y:e.y},left:{x:e.x-this.tile.width,y:e.y+this.tile.height/2},right:{x:e.x,y:e.y+this.tile.height/2},bottom:{x:e.x-this.tile.width/2,y:e.y+this.tile.height}}),this.getTileRect=e=>({topRight:e,bottomLeft:{x:e.x-this.tile.width,y:e.y+this.tile.height},bottomRight:{x:e.x,y:e.y+this.tile.height},topLeft:{x:e.x-this.tile.width,y:e.y}}),this.isOnMap=e=>e.x>=0&&e.x<this.mapSize.width&&e.y>=0&&e.y<this.mapSize.height;const s=document.getElementById(t.canvasId??"canvas");if(null==s)throw new Error("canvas is null!");const i=s.getContext("2d");if(null==i)throw new Error("2d context from canvas is null!");this.screenSize={width:t.screen.width,height:t.screen.height},s.setAttribute("width",`${this.screenSize.width}`),s.setAttribute("height",`${this.screenSize.height}`),this.mapSize={width:t.mapSize.width,height:t.mapSize.height},this.tile={width:t.tileSize.width,height:t.tileSize.height,color:t.color??"#15B89A"},this.mapPos={x:this.screenSize.width/2,y:2*this.tile.height},this._canvas=s,this.context=i}compare(e){return 0}get canvas(){return this._canvas}addTiles(e){for(let t=0;t<this.mapSize.width;t++)for(let s=0;s<this.mapSize.height;s++)this._addTile({x:t,y:s},e)}start(e=30){this.gameLoopItnterval=setInterval((()=>this.render()),1e3/e)}render(){this.clear(),this.renderLayers[0].sort(((e,t)=>e.compare(t))).forEach((e=>e.render())),this.renderLayers[1].concat(this.renderLayers[2]).sort(((e,t)=>e.compare(t))).forEach((e=>e.render()))}_findEntity(e,t){return this.renderLayers[e].find(t)}findTileByScreenPos(e){return this._findEntity(0,((t,s)=>{const i=this.convertScreenToIso(e),{mapPos:n}=t;return n.x===i.x&&n.y===i.y}))}findTileByIsoPos(e,t){return this._findEntity(t,((t,s)=>{const{mapPos:i}=t;return i.x===e.x&&i.y===e.y}))}convertScreenToIso(e){const t=(e.x-this.mapPos.x)/this.tile.width,s=(e.y-this.mapPos.y)/this.tile.height;return{x:Math.floor(s+t),y:Math.floor(s-t)}}loadImages(...e){return Promise.all(e.map((e=>function(e){const t=(e=>{const t=e.split("/");if(t.length>0){const e=t[t.length-1],s=/(.+)[.](.+)$/.exec(e);if(null!=s)return s[1]}})(e);if(!t)return console.warn(`image path: ${e} is not valid!`),Promise.resolve(null);return new Promise(((s,i)=>{let n=new Image;n.onload=i=>{console.log(`image ${t} from path: ${e} loaded`,i),s({name:t,img:n})},n.onerror=t=>{console.warn(`error loading image path: ${e}`,t),s(null)},n.onabort=t=>{console.warn(`abort loading image path: ${e}`,t),s(null)},n.src=e}))}(e)))).then((e=>{e.filter((e=>null!=e)).forEach((e=>this.images.set(e.name,e.img)))}))}renderImageScaled(e,t,s){const i=this.images.get(e);if(i){const e=s.width/i.width,n=s.height/i.height,r=Math.min(e,n),{bottomLeft:{x:o,y:h}}=this.getTileRect(t);this.context.drawImage(i,0,0,i.width,i.height,o,h-s.height,i.width*r,i.height*r)}}renderImage(e,t){const s=this.images.get(e);if(s){const{bottomLeft:{x:e,y:i}}=this.getTileRect(t);this.context.drawImage(s,e,i-s.naturalHeight)}}checkCollision(e,s,i,n){const r=n?this.renderLayers[i].filter(n):this.renderLayers[i],o=this.getTileVertex(e);let h;switch(s){case t.SW:case t.SE:h=e=>{const{top:t,left:s}=this.getTileVertex(e.screenPos),{x:i,y:n}=o.left;return i<t.x&&i>=s.x&&n>t.y&&n<=s.y};break;case t.NW:case t.NE:h=e=>{const{bottom:t,right:s}=this.getTileVertex(e.screenPos),{x:i,y:n}=o.right;return i>t.x&&i<=s.x&&n<t.y&&n>=s.y}}return!!h&&void 0!==r.find(h)}}({screen:{width:2048,height:1600},mapSize:{width:14,height:14},tileSize:{width:64,height:32}});l.loadImages("assets/man-ne.png","assets/man-nw.png","assets/man-se.png","assets/man-sw.png","assets/tiles/grass01.png","assets/tiles/rock.png","assets/tiles/snow.png","assets/tiles/brickpavers2.png","assets/tiles/cretebrick970.png","assets/wall-low-single.png").then((function(){l.addTiles(0),l.start();let e=h("ArrowLeft"),s=h("ArrowUp"),i=h("ArrowRight"),r=h("ArrowDown");const m=(d=document.body,new o(d));var d;let g;m.press=e=>{let t=m.getMousePosition(e);null!=t&&(t=l.convertScreenToIso(t),l.addEntity(new a("wall-low-single",l.convertIsoToScreen(t),l),1))},m.move=e=>{const t=m.getMousePosition(e);if(null!=t){const e=l.convertScreenToIso(t);c.innerHTML=`[${t.x},${t.y}] - [${e.x},${e.y}]`;const s=l.findTileByIsoPos(e,0);s&&(g&&(g.highlight=!1),g=s,g.highlight=!0)}};const p=new n({x:1,y:1},l);l.addEntity(p,2);const y=()=>p.move=null;e.press=()=>p.move=t.SW,i.press=()=>p.move=t.NE,s.press=()=>p.move=t.NW,r.press=()=>p.move=t.SE,e.release=y,i.release=y,r.release=y,s.release=y}));
//# sourceMappingURL=index.93e8f5cf.js.map
