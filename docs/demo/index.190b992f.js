class e{constructor(e,t,s){this.screenPos=e,this.mapPos=t,this.map=s,this.highlight=!1,console.log(`screen: [${this.screenPos.x},${this.screenPos.y}} - map:[${this.mapPos.x},${this.mapPos.y}]`)}compare(e){return e.highlight?-1:0}render(){const e=this.map.getTileVertex(this.screenPos),{x:t,y:s}=this.screenPos,{context:i,tile:{color:n}}=this.map;i.save(),i.beginPath(),i.moveTo(e.top.x,e.top.y),i.lineTo(e.left.x,e.left.y),i.lineTo(e.bottom.x,e.bottom.y),i.lineTo(e.right.x,e.right.y),i.lineTo(e.top.x,e.top.y),i.strokeStyle="black",i.stroke(),i.fillStyle=this.highlight?"#ffff00":n,i.fill(),this.highlight&&(this._drawTileRect(),this._drawMapPos()),i.restore()}_drawMapPos(){const{context:e}=this.map,{x:t,y:s}=this.screenPos;e.fillStyle="black",e.fillText(`${this.mapPos.x},${this.mapPos.y}`,t-40,s+20)}_drawTileRect(){const{context:e,tile:{width:t,height:s}}=this.map,{topLeft:{x:i,y:n}}=this.map.getTileRect(this.screenPos);e.beginPath(),e.rect(i,n,t,s),e.stroke()}}class t{constructor(e,t){this.screenPos=e,this.map=t,console.log("prism",e)}compare(e){const t=this.screenPos.y-e.screenPos.y;return 0===t?this.screenPos.x-e.screenPos.x:t}render(){const{x:e,y:t}=this.screenPos,{context:s,tile:{width:i,height:n,color:o}}=this.map;s.beginPath(),s.moveTo(e-i/2,t-n),s.lineTo(e-i,t-n/2),s.lineTo(e-i/2,t),s.lineTo(e,t-n/2),s.lineTo(e-i/2,t-n),s.fillStyle="#555555",s.fill(),s.beginPath(),s.moveTo(e-i,t-n/2),s.lineTo(e-i,t+n/2),s.lineTo(e-i/2,t+n),s.lineTo(e-i/2,t),s.lineTo(e-i,t-n/2),s.fillStyle="#444444",s.fill(),s.beginPath(),s.moveTo(e-i/2,t),s.lineTo(e,t-n/2),s.lineTo(e,t+n/2),s.lineTo(e-i/2,t+n),s.lineTo(e-i/2,t),s.fillStyle="#777777",s.fill()}}class s{constructor(e,t){this.value=e,this.isDown=!1,this.isUp=!0;const s=e=>{e.key===this.value&&(this.isUp&&this.press&&this.press(),this.isDown=!0,this.isUp=!1,e.preventDefault())},i=e=>{e.key===this.value&&(this.isDown&&this.release&&this.release(),this.isDown=!1,this.isUp=!0,e.preventDefault())};t.addEventListener("keydown",s,!1),t.addEventListener("keyup",i,!1),this.unsubscribe=()=>{t.removeEventListener("keydown",s,!1),t.removeEventListener("keyup",i,!1)}}}class i{constructor(e){const t=e=>{this.press&&this.press(e),e.preventDefault()},s=e=>{this.up&&this.up(e),e.preventDefault()},i=e=>{this.move&&this.move(e),e.preventDefault()};e.addEventListener("mousedown",t,!1),e.addEventListener("mouseup",s,!1),e.addEventListener("mousemove",i,!1),this.unsubscribe=()=>{e.removeEventListener("mousedown",t,!1),e.removeEventListener("mouseup",s,!1),e.removeEventListener("mousemove",i,!1)}}getMousePosition(e){const t=e.target;if(null==t)return null;const s=t.getBoundingClientRect();return{x:e.clientX-s.left,y:e.clientY-s.top}}}const n=(e,t=document)=>new s(e,t),o=document.getElementById("debug"),h=new class{constructor(t){this.screenPos={x:0,y:0},this.renderLayers=[[],[]],this.images=new Map,this.clear=()=>this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this._addTile=(t,s=0)=>{const i=this.convertIsoToScreen(t),n=new e(i,t,this);return this.renderLayers[s].push(n),n},this._sortLayer=e=>this.renderLayers[e].sort(((e,t)=>e.compare(t))),this.addEntity=(e,t=1)=>{const s=this.convertScreenToIso(e.screenPos);return!!this.isOnMap(s)&&(this.renderLayers[t].push(e),!0)},this.convertIsoToScreen=e=>({x:(e.x-e.y)*this.tile.width/2+this.mapPos.x,y:(e.x+e.y)*this.tile.height/2+this.mapPos.y}),this.getTileVertex=e=>({top:{x:e.x-this.tile.width/2,y:e.y},left:{x:e.x-this.tile.width,y:e.y+this.tile.height/2},right:{x:e.x,y:e.y+this.tile.height/2},bottom:{x:e.x-this.tile.width/2,y:e.y+this.tile.height}}),this.getTileRect=e=>({topRight:e,bottomLeft:{x:e.x-this.tile.width,y:e.y+this.tile.height},bottomRight:{x:e.x,y:e.y+this.tile.height},topLeft:{x:e.x-this.tile.width,y:e.y}}),this.isOnMap=e=>e.x>=0&&e.x<this.mapSize.width&&e.y>=0&&e.y<this.mapSize.height;const s=document.getElementById(t.canvasId??"canvas");if(null==s)throw new Error("canvas is null!");const i=s.getContext("2d");if(null==i)throw new Error("2d context from canvas is null!");this._canvas=s,this.context=i,this.screenSize={width:t.screen.width,height:t.screen.height},this.mapSize={width:t.mapSize.width,height:t.mapSize.height},this.tile={width:t.tileSize.width,height:t.tileSize.height,color:t.color??"#15B89A"},this.mapPos={x:this.screenSize.width/2,y:2*this.tile.height}}compare(e){return 0}get canvas(){return this._canvas}create(){this._canvas.setAttribute("width",`${this.screenSize.width}`),this._canvas.setAttribute("height",`${this.screenSize.height}`);for(let e=0;e<this.mapSize.width;e++)for(let t=0;t<this.mapSize.height;t++)this._addTile({x:e,y:t});this.gameLoopItnterval=setInterval((()=>this.render()),1e3/30)}render(){this.clear(),this._sortLayer(0),this.renderLayers[0].forEach((e=>e.render())),this._sortLayer(1),this.renderLayers[1].forEach((e=>e.render()))}_findEntity(e,t){return this.renderLayers[e].find(t)}findTileByScreenPos(e){return this._findEntity(0,((t,s)=>{const i=this.convertScreenToIso(e),{mapPos:n}=t;return n.x===i.x&&n.y===i.y}))}findTileByIsoPos(e){return this._findEntity(0,((t,s)=>{const{mapPos:i}=t;return i.x===e.x&&i.y===e.y}))}convertScreenToIso(e){const t=(e.x-this.mapPos.x)/this.tile.width,s=(e.y-this.mapPos.y)/this.tile.height;return{x:Math.floor(s+t),y:Math.floor(s-t)}}loadImages(...e){e.forEach((e=>{const t=(e=>{const t=e.split("/");if(t.length>0){const e=t[t.length-1],s=/(.+)[.](.+)$/.exec(e);if(null!=s)return s[1]}})(e);if(t){let s=new Image;s.src=e,s.onload=s=>{console.log(`image ${t} from path: ${e} loaded`,s)},this.images.set(t,s)}else console.warn(`image path: ${e} is not valid!`)}))}renderImage(e,t){const s=this.images.get(e);if(s){const{bottomLeft:{x:e,y:i}}=this.getTileRect(t);this.context.drawImage(s,e,i-s.naturalHeight)}}}({screen:{width:1024,height:800},mapSize:{width:14,height:14},tileSize:{width:64,height:32}});h.create(),h.loadImages("assets/man-ne.png","assets/man-nw.png","assets/man-se.png"," assets/man-sw.png");let r=n("ArrowLeft"),a=n("ArrowUp"),c=n("ArrowRight"),l=n("ArrowDown");const m=(p=document.body,new i(p));var p;let d;m.press=e=>{let s=m.getMousePosition(e);null!=s&&(s=h.convertScreenToIso(s),h.addEntity(new t(h.convertIsoToScreen(s),h)))},m.move=e=>{const t=m.getMousePosition(e);if(null!=t){const e=h.convertScreenToIso(t);o.innerHTML=`[${t.x},${t.y}] - [${e.x},${e.y}]`;const s=h.findTileByIsoPos(e);s&&(d&&(d.highlight=!1),d=s,d.highlight=!0)}};const y=new class{constructor(e,t){this.mapPos=e,this.map=t,this.move="none",this.currentImage="man-se",this.screenPos=t.convertIsoToScreen(e)}compare(e){const t=this.screenPos.y-e.screenPos.y;return 0===t?this.screenPos.x-e.screenPos.x:t}render(){switch(this.move){case"down":this.map.isOnMap({x:this.mapPos.x+1,y:this.mapPos.y})&&(this.mapPos.x+=1,this.currentImage="man-se");break;case"left":this.map.isOnMap({x:this.mapPos.x,y:this.mapPos.y+1})&&(this.mapPos.y+=1,this.currentImage="man-sw");break;case"right":this.map.isOnMap({x:this.mapPos.x,y:this.mapPos.y-1})&&(this.mapPos.y-=1,this.currentImage="man-ne");break;case"up":this.map.isOnMap({x:this.mapPos.x-1,y:this.mapPos.y})&&(this.mapPos.x-=1,this.currentImage="man-nw")}this.screenPos=this.map.convertIsoToScreen(this.mapPos),this.map.renderImage(this.currentImage,this.screenPos)}}({x:1,y:1},h);h.addEntity(y),r.press=()=>{y.move="left"},r.release=()=>{y.move="none"},c.press=()=>{y.move="right"},c.release=()=>{y.move="none"},a.press=()=>{y.move="up"},a.release=()=>{y.move="none"},l.press=()=>{y.move="down"},l.release=()=>{y.move="none"};
//# sourceMappingURL=index.190b992f.js.map
