class e{constructor(e,s,t){this.screenPos=e,this.mapPos=s,this.map=t}render(){const{x:e,y:s}=this.screenPos,{context:t,tile:{width:i,height:n,color:o}}=this.map;t.beginPath(),t.moveTo(e-i/2,s),t.lineTo(e-i,s+n/2),t.lineTo(e-i/2,s+n),t.lineTo(e,s+n/2),t.lineTo(e-i/2,s),t.stroke(),t.fillStyle=o,t.fill(),t.fillStyle="black",t.fillText(`${this.mapPos.x},${this.mapPos.y}`,e-40,s+20)}}class s{constructor(e,s){this.screenPos=e,this.map=s,console.log("prism",e)}render(){const{x:e,y:s}=this.screenPos,{context:t,tile:{width:i,height:n,color:o}}=this.map;t.beginPath(),t.moveTo(e-i/2,s-n),t.lineTo(e-i,s-n/2),t.lineTo(e-i/2,s),t.lineTo(e,s-n/2),t.lineTo(e-i/2,s-n),t.fillStyle="#555555",t.fill(),t.beginPath(),t.moveTo(e-i,s-n/2),t.lineTo(e-i,s+n/2),t.lineTo(e-i/2,s+n),t.lineTo(e-i/2,s),t.lineTo(e-i,s-n/2),t.fillStyle="#444444",t.fill(),t.beginPath(),t.moveTo(e-i/2,s),t.lineTo(e,s-n/2),t.lineTo(e,s+n/2),t.lineTo(e-i/2,s+n),t.lineTo(e-i/2,s),t.fillStyle="#777777",t.fill()}}class t{constructor(e,s){this.value=e,this.isDown=!1,this.isUp=!0;const t=e=>{e.key===this.value&&(this.isUp&&this.press&&this.press(),this.isDown=!0,this.isUp=!1,e.preventDefault())},i=e=>{e.key===this.value&&(this.isDown&&this.release&&this.release(),this.isDown=!1,this.isUp=!0,e.preventDefault())};s.addEventListener("keydown",t,!1),s.addEventListener("keyup",i,!1),this.unsubscribe=()=>{s.removeEventListener("keydown",t,!1),s.removeEventListener("keyup",i,!1)}}}class i{constructor(e){this.isDown=!1,this.isUp=!0;const s=e=>{this.isUp&&this.press&&this.press(e),this.isDown=!0,this.isUp=!1,e.preventDefault()},t=e=>{this.isDown&&this.up&&this.up(e),this.isDown=!1,this.isUp=!0,e.preventDefault()};e.addEventListener("mousedown",s,!1),e.addEventListener("mouseup",t,!1),this.unsubscribe=()=>{e.removeEventListener("mousedown",s,!1),e.removeEventListener("mouseup",t,!1)}}}const n=(e,s=document)=>new t(e,s);const o=new class{constructor(s){this.screenPos={x:0,y:0},this.renderLayers=[[],[]],this.images=new Map,this.clear=()=>this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this._addTile=(s,t=0)=>{const i=this.convertIsoToScreen(s),n=new e(i,s,this);return this.renderLayers[t].push(n),n},this._sortLayer=e=>this.renderLayers[e].sort(((e,s)=>{const t=e.screenPos.y-s.screenPos.y;return 0===t?s.screenPos.x-e.screenPos.x:t})),this.addEntity=(e,s=1)=>{const t=this.convertScreenToIso(e.screenPos);return!!this.isOnMap(t)&&(this.renderLayers[s].push(e),this._sortLayer(s),!0)},this.convertIsoToScreen=e=>({x:(e.x-e.y)*this.tile.width/2+this.mapPos.x,y:(e.x+e.y)*this.tile.height/2+this.mapPos.y}),this.isOnMap=e=>e.x>=0&&e.x<this.mapSize.width&&e.y>=0&&e.y<this.mapSize.height;const t=document.getElementById(s.canvasId??"canvas");if(null==t)throw new Error("canvas is null!");const i=t.getContext("2d");if(null==i)throw new Error("2d context from canvas is null!");this._canvas=t,this.context=i,this.screenSize={width:s.screen.width,height:s.screen.height},this.mapSize={width:s.mapSize.width,height:s.mapSize.height},this.tile={width:s.tileSize.width,height:s.tileSize.height,color:s.color??"#15B89A"},this.mapPos={x:this.screenSize.width/2,y:this.tile.height}}get canvas(){return this._canvas}create(){this._canvas.setAttribute("width",`${this.screenSize.width}`),this._canvas.setAttribute("height",`${this.screenSize.height}`);for(let e=0;e<this.mapSize.width;e++)for(let s=0;s<this.mapSize.height;s++)this._addTile({x:e,y:s});this.gameLoopItnterval=setInterval((()=>this.render()),500)}render(){this.renderLayers[0].forEach((e=>e.render())),this.renderLayers[1].forEach((e=>e.render()))}convertScreenToIso(e){const s=(e.x-this.mapPos.x)/this.tile.width,t=(e.y-this.mapPos.y)/this.tile.height;return{x:Math.floor(t+s),y:Math.floor(t-s)}}loadImages(...e){e.forEach((e=>{const s=(e=>{const s=e.split("/");if(s.length>0){const e=s[s.length-1],t=/(.+)[.](.+)$/.exec(e);if(null!=t)return t[1]}})(e);if(s){let t=new Image;t.src=e,t.onload=t=>{console.log(`image ${s} from path: ${e} loaded`,t)},this.images.set(s,t)}else console.warn(`image path: ${e} is not valid!`)}))}}({screen:{width:1024,height:768},mapSize:{width:14,height:14},tileSize:{width:64,height:32}});o.create(),o.loadImages("/assets/man-ne.png","/assets/man-nw.png","/assets/man-se.png"," /assets/man-sw.png");let r=n("ArrowLeft"),h=n("ArrowUp"),a=n("ArrowRight"),l=n("ArrowDown");var c;(c=o.canvas,new i(c)).press=e=>{let t=function(e){const s=e.target;if(null==s)return null;const t=s.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}}(e);null!=t&&(t=o.convertScreenToIso(t),o.addEntity(new s(o.convertIsoToScreen(t),o)))};const d=new class{constructor(e,s,t){this.basename=e,this.screenPos=s,this.map=t,console.log("image",s),this.source=t.images.get(e)}render(){if(this.source){const{x:e,y:s}=this.screenPos;this.map.context.drawImage(this.source,e,s)}else this.source=this.map.images.get(this.basename)}}("man-ne",o.convertIsoToScreen({x:0,y:0}),o),p=o.addEntity(d);console.log("add image ",p),r.press=()=>{console.log("left press")},a.press=()=>{console.log("right press")},h.press=()=>{console.log("up press")},l.press=()=>{console.log("down press")};
//# sourceMappingURL=index.c2273642.js.map
